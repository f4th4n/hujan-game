const config={mode:"development",debug:!1},data={categories:["flower","wood","fruit","herb","magical"],levels:[{index:1,dropRate:{flower:.75,wood:.25,fruit:0,herb:0,magical:0}},{index:2,dropRate:{flower:.3,wood:.7,fruit:0,herb:0,magical:0}},{index:3,dropRate:{flower:.2,wood:.2,fruit:.6,herb:0,magical:0}}],plants:{lotus:{id:"lotus",name:"Lotus",category:"flower",animationMode:"flip"}}},helper={virtual:{width:480,height:270},zOrder:{zero:0,low:1,medium:5,high:10},insideFBIframe:()=>{try{return window.self!==window.top}catch(e){return!0}}};var model={user:{firstTime:!0,plantsCollection:[]},local:{cloud:{scheduleUpdatePos:{x:-200,on:+new Date}},plants:[]},constant:{plantY:-1},async initUser(){const e=localStorage.getItem("user");null!==e&&(this.user=JSON.parse(e))},setUser(e,t){this.user[e]=t,localStorage.setItem("user",JSON.stringify(this.user))},getUser(e){return this.user[e]}};const resource={img:{bg:"assets/img/bg.png",flower1:"assets/img/flower_1.png",cloud:"assets/img/cloud.png",ground:"assets/img/ground.png",seed:"assets/img/seed.png",fingerPoint1:"assets/img/finger_point_1.png",fingerPoint2:"assets/img/finger_point_2.png",whiteSquare:"assets/img/white_square.png"},fonts:{pou:{type:"font",name:"Pou",srcs:["dist/fonts/Pou-RMR6.ttf"]}},particles:{rain:"assets/particle_rain.plist"},preload:{}};resource.preload={homeScene:[],playScene:[resource.img.bg,resource.img.flower1,resource.img.cloud,resource.img.ground,resource.img.seed,resource.fonts.pou,resource.particles.rain]};class Grow{update(e,t){this.cloud=e,this.layer=t,this.modelCloudX=model.local.cloud.scheduleUpdatePos.x;const i=this.cloud.width/2,s=10*this.modelCloudX/100,o=parseInt(this.modelCloudX-i+s),r=parseInt(this.modelCloudX+i-s),n=o<r?o:r,c=o<r?r:o;if(c<0)return!1;var a=!1;for(let e of model.local.plants)e.x>=n&&e.x<=c&&(e.age+=1,a=!0);if(a)return;const l=new PrefabPlant("random");model.local.plants.push(l),this.layer.addChild(l,helper.zOrder.high)}}const grow=new Grow,PrefabSeed=cc.Sprite.extend({ctor:function(){this._super(),this.initWithFile(resource.img.seed),this.setAnchorPoint(0,0),this.setPosition(200,0),this.setScale(.2),this.setPositionX(.6*cc.director.getWinSize().width)},onEnter:function(){}}),PrefabPlant=cc.Sprite.extend({age:1,SEED_SCALE:.2,SHOW_SEED_AFTER:2,BLOOM_AFTER:5,mode:"hidden-seed",ctor:function(e){this._super(),this.rowPlant=this.getRowPlant(e),this.setScale(this.SEED_SCALE),this.setAnchorPoint(.5,0),this.setPositionX(model.local.cloud.scheduleUpdatePos.x),this.setPositionY(model.constant.plantY),this.ageListener(),this.animate()},getRowPlant(e){if("random"===e){const e=Object.keys(data.plants);return data.plants[e[e.length*Math.random()<<0]]}return data.plants[e]},getTexture(e){return`assets/img/plant_${this.rowPlant.category}_${this.rowPlant.id}_${e}.png`},animate:function(){var e=1;this.schedule(()=>{"bloom"===this.mode&&("flip"===this.rowPlant.animationMode?(this.scaleX*=-1,this.setTexture(this.getTexture(1))):(++e>this.rowPlant.animationMode&&(e=1),this.setTexture(this.getTexture(e))))},3)},prevAge:1,prevMode:null,ageListener:function(){this.schedule(()=>{this.prevAge!=this.age&&(this.prevMode==this.mode&&"bloom"===this.mode||(this.age<this.SHOW_SEED_AFTER?this.mode="hidden-seed":this.age<this.BLOOM_AFTER?(this.mode="seed",this.setTexture(resource.img.seed)):(this.mode="bloom",this.setTexture(this.getTexture(1)),setTimeout(()=>this.setTexture(this.getTexture(1)),50),this.setScale(.35)),this.prevAge=this.age,this.prevMode=this.mode))},.1)}}),PrefabFingerPointHelper=cc.Sprite.extend({flipFlop:!0,ctor:function(){this._super();const e=cc.director.getWinSize();this.initWithFile(resource.img.fingerPoint1),this.setPosition(e.width/2,e.height/2),this.flipImage()},flipImage:function(){this.schedule(()=>{model.user.firstTime?(this.flipFlop?this.setTexture(resource.img.fingerPoint2):this.setTexture(resource.img.fingerPoint1),this.flipFlop=!this.flipFlop):this.removeFromParent()},.7)}}),layers={play:{Bg:null,Level:null}};layers.play.Bg=cc.Layer.extend({ctor:function(){this._super(),this.printBg()},printBg:function(){const e=new cc.Sprite(resource.img.whiteSquare);e.setColor(cc.color.WHITE),e.setScaleX(cc.winSize.width/100+1),e.setScaleY(cc.winSize.height/100+1),e.setAnchorPoint(0,0),window.whiteRect=e,this.addChild(e,helper.zOrder.high)}}),layers.play.Level=cc.Layer.extend({isPrintRaindrop:!1,seeds:[],plants:[],ctor:function(){this._super(),this.printLabels(),this.printHelper();const e=this.printCloud(),t=this.printRaindrop(e),i=this.printGround();this.scheduleCloud(e,t),this.scheduleGround(i)},printHelper(){if(!model.user.firstTime)return;const e=new PrefabFingerPointHelper;return this.addChild(e,helper.zOrder.low),e},printCloud:function(){const e=cc.Sprite.create(resource.img.cloud);return e.setAnchorPoint(.5,.5),e.setScale(.4),e.setPosition(-100,.85*cc.director.getWinSize().height),this.addChild(e,helper.zOrder.medium),e},printRaindrop:function(e){if(!this.isPrintRaindrop)return;const t=cc.ParticleSystem.create(resource.particles.rain);return t.setScale(.6),t.setPosition(e.width/2,.35*e.height*-1),t.setAnchorPoint(0,0),t.setDrawMode(cc.ParticleSystem.TEXTURE_MODE),t.setBlendFunc(cc.BlendFunc.ALPHA_PREMULTIPLIED),e.addChild(t,helper.zOrder.low),t},printGround:function(){const e=new cc.Sprite(resource.img.ground);return e.setAnchorPoint(0,0),e.setPosition(-50,0),this.addChild(e,helper.zOrder.medium),e},printLabels:function(){const e=cc.LabelTTF.create("Hujan",resource.fonts.pou.name,24);e.setPosition(.01*cc.director.getWinSize().width,cc.director.getWinSize().height-.01*cc.director.getWinSize().height),e.setColor("black"),e.setAnchorPoint(0,1),this.addChild(e,helper.zOrder.medium)},scheduleCloud:function(e,t){e.schedule(t=>{if(+new Date<model.local.cloud.scheduleUpdatePos.on)return;const i=Math.abs(model.local.cloud.scheduleUpdatePos.x-e.x)/1e3,s=i<.5?.5:i,o=cc.moveTo(s,cc.p(model.local.cloud.scheduleUpdatePos.x,e.y)).clone().easing(cc.easeBackOut());e.runAction(cc.sequence(o)),model.local.cloud.scheduleUpdatePos.on=2*+new Date}),e.schedule(()=>{grow.update(e,this)},1)},scheduleGround:function(e){e.scheduleOnce(()=>{const t=.08*e.height;model.constant.plantY=e.y+e.height-t})}});const HomeScene=cc.Scene.extend({onEnter:function(){this._super()}}),LevelScene=cc.Scene.extend({onEnter:function(){this._super(),this.createLayers(),this.addListener()},createLayers:function(){this.addChild(new layers.play.Bg,helper.zOrder.low),this.addChild(new layers.play.Level,helper.zOrder.medium)},setCloudPos(e){model.local.cloud.scheduleUpdatePos={x:e,on:+new Date},model.setUser("firstTime",!1)},addListener:function(){const e=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,onTouchBegan:(e,t)=>(this.setCloudPos(e.getLocationX(),!0),!0),onTouchEnded:(e,t)=>{}});cc.eventManager.addListener(e,this)}}),CollectionScene=cc.Scene.extend({onEnter:function(){this._super()}}),app={startGame:()=>{}};app.startGame=async()=>{await model.initUser();cc.game.run("gameCanvas",async()=>{cc.loader.onProgress=function(e,t,i){const s=100*e/t;console.log("progress",s),"production"===config.mode&&FBInstant.setLoadingProgress(s)},cc.director.setDisplayStats(config.debug),"production"===config.mode&&await FBInstant.initializeAsync(),cc.sys.isBrowser&&cc.sys.os===cc.sys.OS_ANDROID&&(cc.macro.DOWNLOAD_MAX_CONCURRENT=2),cc.LoaderScene.preload(resource.preload.playScene,(async function(){"production"===config.mode&&await FBInstant.startGameAsync(),cc.director.runScene(new LevelScene)}),this)})},window.onload=app.startGame;