const config={mode:"production",debug:!1},data={categories:["flower","wood","fruit","herb","magical"],plants:[{id:"lotus",name:"Lotus",category:"flower",animationMode:"flip",level:1},{id:"orchid",name:"Orchid",category:"flower",animationMode:2,level:1},{id:"ffff",name:"ffff",category:"flower",animationMode:2,level:2},{id:"ggggg",name:"ggggg",category:"flower",animationMode:2,level:3}],levels:[{index:1,plantIds:["lotus","orchid"]},{index:2},{index:3}]},helper={virtual:{width:480,height:270},zOrder:{zero:0,low:1,medium:5,high:10},insideFBIframe:()=>{try{return window.self!==window.top}catch(e){return!0}}};var model={user:{firstTime:!0,plantsCollection:[],level:1},local:{cloud:{scheduleUpdatePos:{x:-200,on:+new Date}},plants:[]},once:{plantY:-1},async initUser(){if("production"===config.mode){const e=await FBInstant.player.getDataAsync(["firstTime","plantsCollection","level"]);!1===e.firstTime&&(this.user={...this.user,...e})}else{const e=localStorage.getItem("user");null!==e&&(this.user=JSON.parse(e))}},async setUser(e,t){if(this.user[e]=t,"production"===config.mode){var i={};i[e]=t,await FBInstant.player.setDataAsync(i)}else localStorage.setItem("user",JSON.stringify(this.user))},getUser(e){return this.user[e]}};const resource={img:{bg:"assets/img/bg.png",cloud:"assets/img/cloud.png",ground:"assets/img/ground.png",seed:"assets/img/seed.png",fingerPoint1:"assets/img/finger_point_1.png",fingerPoint2:"assets/img/finger_point_2.png",whiteSquare:"assets/img/white_square.png",runtime:{level1:["assets/img/plant_flower_lotus_1.png","assets/img/plant_flower_orchid_1.png","assets/img/plant_flower_orchid_2.png"]}},fonts:{pou:{type:"font",name:"Pou",srcs:["dist/fonts/Pou-RMR6.ttf"]}},particles:{rain:"assets/particle_rain.plist"},preload:{}};resource.preload={homeScene:[],playScene:[resource.img.bg,resource.img.cloud,resource.img.ground,resource.img.seed,resource.fonts.pou,resource.particles.rain]};class Grow{update(e,t){this.cloud=e,this.layer=t,this.modelCloudX=model.local.cloud.scheduleUpdatePos.x;const i=10*this.modelCloudX/100,s=this.modelCloudX-i,o=this.modelCloudX+i;if(o<0)return!1;var r=!1;for(let e of model.local.plants)e.x>=s&&e.x<=o&&(e.age+=1,r=!0);if(r)return;const n=new PrefabPlant;model.local.plants.push(n),this.layer.addChild(n,helper.zOrder.low)}}const grow=new Grow,PrefabSeed=cc.Sprite.extend({ctor:function(){this._super(),this.initWithFile(resource.img.seed),this.setAnchorPoint(0,0),this.setPosition(200,0),this.setScale(.2),this.setPositionX(.6*cc.director.getWinSize().width)},onEnter:function(){}}),PrefabPlant=cc.Sprite.extend({age:1,SEED_SCALE:.2,SHOW_SEED_AFTER:2,BLOOM_AFTER:5,mode:"hidden-seed",ctor:function(){this._super(),this.rowPlant=this.getRowPlant(),this.setScale(this.SEED_SCALE),this.setAnchorPoint(.5,.5),this.setPositionX(model.local.cloud.scheduleUpdatePos.x),this.setPositionY(model.once.plantY),this.ageListener(),this.animate()},getRowPlant(){const e=data.plants.filter(e=>e.level<=model.user.level);return e[Math.floor(Math.random()*e.length)]},getTexture(e){return`assets/img/plant_${this.rowPlant.category}_${this.rowPlant.id}_${e}.png`},animate:function(){var e=1;this.schedule(()=>{"bloom"===this.mode&&("flip"===this.rowPlant.animationMode?(this.scaleX*=-1,this.setTexture(this.getTexture(1))):(++e>this.rowPlant.animationMode&&(e=1),this.setTexture(this.getTexture(e))))},3)},doneSeed:!1,doneBloom:!1,ageListener:function(){this.schedule(()=>{if(this.age<this.SHOW_SEED_AFTER)this.mode="hidden-seed";else if(this.age<this.BLOOM_AFTER){if(this.doneSeed)return;this.mode="seed",this.setTexture(resource.img.seed);const e=this.y/4,t=cc.moveBy(1,cc.p(0,e)).clone().easing(cc.easeBackOut());this.runAction(cc.sequence(t)),this.doneSeed=!0}else{if(this.doneBloom)return;this.mode="bloom",this.setPositionY(model.once.plantY),this.setTexture(this.getTexture(1)),this.setScale(.35),this.zIndex=helper.zOrder.high+1,this.setAnchorPoint(.5,0),model.setUser("plantsCollection",[...model.user.plantsCollection,this.rowPlant.id]),this.doneBloom=!0}},.1)}}),PrefabFingerPointHelper=cc.Sprite.extend({flipFlop:!0,ctor:function(){this._super();const e=cc.director.getWinSize();this.initWithFile(resource.img.fingerPoint1),this.setPosition(e.width/2,e.height/2),this.flipImage()},flipImage:function(){this.schedule(()=>{model.user.firstTime?(this.flipFlop?this.setTexture(resource.img.fingerPoint2):this.setTexture(resource.img.fingerPoint1),this.flipFlop=!this.flipFlop):this.removeFromParent()},.7)}}),layers={play:{Bg:null,Level:null,Sidebar:null}};layers.play.Sidebar=cc.Layer.extend({ctor:function(){this._super(),this.printTitle(),this.updateSidebarKeys(),this.schedule(()=>{this.updateSidebarKeys()},1),this.schedule(()=>{this.updateSidebarValues()},.1)},printTitle:function(){const e=cc.LabelTTF.create("Hujan",resource.fonts.pou.name,24);e.setPosition(.01*cc.director.getWinSize().width,cc.director.getWinSize().height-.01*cc.director.getWinSize().height),e.setColor("black"),e.setAnchorPoint(0,1),this.addChild(e,helper.zOrder.medium)},sidebarKeys:[],updateSidebarKeys:function(){for(let e of this.sidebarKeys)this.removeChild(e);this.sidebarKeys=[];const e=data.plants.filter(e=>e.level===model.user.level).map(e=>e.name);var t=0;for(let i of e){const e=cc.LabelTTF.create(i,resource.fonts.pou.name,16);e.setPosition(cc.director.getWinSize().width-.08*cc.director.getWinSize().width,cc.director.getWinSize().height-.1*cc.director.getWinSize().height+1*t),e.setColor("black"),e.setAnchorPoint(1,1),t=e.height,this.addChild(e,helper.zOrder.medium),this.sidebarKeys.push(e)}},sidebarValues:[],updateSidebarValues:function(e){for(let e of this.sidebarValues)this.removeChild(e);this.sidebarValues=[];const t=data.plants.filter(e=>e.level===model.user.level).map(e=>e.id);var i=0;for(let e of t){const t=model.user.plantsCollection.filter(t=>t===e),s=cc.LabelTTF.create(t.length+"X",resource.fonts.pou.name,16);s.setPosition(cc.director.getWinSize().width-.03*cc.director.getWinSize().width,cc.director.getWinSize().height-.1*cc.director.getWinSize().height+1*i),s.setColor("black"),s.setAnchorPoint(1,1),i=s.height,this.addChild(s,helper.zOrder.medium),this.sidebarValues.push(s)}}}),layers.play.Bg=cc.Layer.extend({ctor:function(){this._super(),this.printBg()},printBg:function(){const e=new cc.Sprite(resource.img.whiteSquare);e.setColor(cc.color.WHITE),e.setScaleX(cc.winSize.width/100+1),e.setScaleY(cc.winSize.height/100+1),e.setAnchorPoint(0,0),this.addChild(e,helper.zOrder.high)}}),layers.play.Level=cc.Layer.extend({CLOUD_SCALE:.4,GROUND_SCALE:.5,isPrintRaindrop:!0,ctor:function(){this._super(),this.loadImages(),this.printHelper();const e=this.printCloud(),t=this.printRaindrop(e),i=this.printGround();this.scheduleCloud(e,t),this.scheduleGround(i)},loadImages(){for(let e of resource.img.runtime.level1)cc.textureCache.addImageAsync(e)},printHelper(){if(!model.user.firstTime)return;const e=new PrefabFingerPointHelper;return this.addChild(e,helper.zOrder.low),e},printCloud:function(){const e=cc.Sprite.create(resource.img.cloud);return e.setAnchorPoint(.5,.5),e.setScale(this.CLOUD_SCALE),e.setPosition(-100,.85*cc.director.getWinSize().height),this.addChild(e,helper.zOrder.medium),e},printRaindrop:function(e){if(!this.isPrintRaindrop)return;const t=cc.ParticleSystem.create(resource.particles.rain);return t.setScale(.6),t.setPosition(e.width/2,.35*e.height*-1),t.setAnchorPoint(0,0),t.setDrawMode(cc.ParticleSystem.TEXTURE_MODE),t.setBlendFunc(cc.BlendFunc.ALPHA_PREMULTIPLIED),e.addChild(t,helper.zOrder.low),t},printGround:function(){const e=new cc.Sprite(resource.img.ground);return e.setAnchorPoint(0,0),e.setPosition(-50,0),e.setScale(this.GROUND_SCALE),this.addChild(e,helper.zOrder.medium),e},scheduleCloud:function(e,t){e.schedule(t=>{if(+new Date<model.local.cloud.scheduleUpdatePos.on)return;model.local.cloud.scheduleUpdatePos.x<e.x?e.scaleX=1*this.CLOUD_SCALE:e.scaleX=-1*this.CLOUD_SCALE;const i=Math.abs(model.local.cloud.scheduleUpdatePos.x-e.x)/1e3,s=i<.5?.5:i,o=cc.moveTo(s,cc.p(model.local.cloud.scheduleUpdatePos.x,e.y)).clone().easing(cc.easeBackOut());e.runAction(cc.sequence(o)),model.local.cloud.scheduleUpdatePos.on=2*+new Date}),e.schedule(()=>{grow.update(e,this)},1)},scheduleGround:function(e){const t=this.GROUND_SCALE;e.scheduleOnce(()=>{window.ground=e,model.once.plantY=e.height*t*.9})}});const HomeScene=cc.Scene.extend({onEnter:function(){this._super()}}),LevelScene=cc.Scene.extend({onEnter:function(){this._super(),this.createLayers(),this.addListener()},createLayers:function(){this.addChild(new layers.play.Bg,helper.zOrder.low),this.addChild(new layers.play.Level,helper.zOrder.medium),this.addChild(new layers.play.Sidebar,helper.zOrder.medium)},setCloudPos(e){model.local.cloud.scheduleUpdatePos={x:e,on:+new Date},model.setUser("firstTime",!1)},addListener:function(){const e=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,onTouchBegan:(e,t)=>(this.setCloudPos(e.getLocationX(),!0),!0),onTouchEnded:(e,t)=>{}});cc.eventManager.addListener(e,this)}}),CollectionScene=cc.Scene.extend({onEnter:function(){this._super()}}),app={startGame:()=>{}};app.startGame=async()=>{cc.game.run("gameCanvas",async()=>{cc.loader.onProgress=function(e,t,i){const s=100*e/t;console.log("progress",s),"production"===config.mode&&FBInstant.setLoadingProgress(s)},cc.director.setDisplayStats(config.debug),"production"===config.mode&&await FBInstant.initializeAsync(),cc.sys.isBrowser&&cc.sys.os===cc.sys.OS_ANDROID&&(cc.macro.DOWNLOAD_MAX_CONCURRENT=2),cc.view.setDesignResolutionSize(800,450,cc.ResolutionPolicy.FIXED_WIDTH),cc.LoaderScene.preload(resource.preload.playScene,(async function(){"production"===config.mode&&await FBInstant.startGameAsync(),await model.initUser(),cc.director.runScene(new LevelScene)}),this)})},window.onload=app.startGame;